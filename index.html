import json

# Load the GeoJSON data from the files
route_geojson_path = r"D:\GeethaAkkaBandarawela\Trip\TripToNorth\Route_FeaturesToJSON.geojson"
cities_geojson_path = r"D:\GeethaAkkaBandarawela\Trip\TripToNorth\SriLankaCities_FeaturesToJSO.geojson"

with open(route_geojson_path, "r") as file:
    route_geojson_data = json.load(file)

with open(cities_geojson_path, "r") as file:
    cities_geojson_data = json.load(file)

city_data = []
for feature in cities_geojson_data['features']:
    properties = feature['properties']
    geometry = feature['geometry']
    longitude, latitude = geometry['coordinates']
    city_name = properties.get('CityName')
    point_order = properties.get('PointOrder', 1)
    city_data.append({"latitude": latitude, "longitude": longitude, "city_name": city_name, "point_order": point_order})

# Sort city_data by point_order
city_data.sort(key=lambda x: x['point_order'])

# Find the index of the point where PointOrder = 1
initial_index = next(i for i, item in enumerate(city_data) if item['point_order'] == 1)

html_content = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Route and Cities Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
    #map {{ height: 100vh; }}
    .leaflet-popup-content-wrapper {{
        background: radial-gradient(circle, rgba(0, 0, 0, 0.8), rgba(138, 43, 226, 0.6), rgba(255, 105, 180, 0.4), rgba(255, 182, 193, 0.2));
        text-align: center;
        color: white;
    }}
    .leaflet-popup-tip {{
        background: radial-gradient(circle, rgba(0, 0, 0, 0.8), rgba(138, 43, 226, 0.6), rgba(255, 105, 180, 0.4), rgba(255, 182, 193, 0.2));
    }}
    .leaflet-popup-content button {{
        background: none;
        border: none;
        color: white;
        font-size: 1.2em;
        cursor: pointer;
    }}
    .custom-marker {{
        width: 12px;
        height: 12px;
        background-color: rgba(138, 43, 226, 0.8);  /* Dark violet */
        border: 2px solid rgba(255, 105, 180, 0.4);  /* Transparent circle */
        border-radius: 50%;
    }}
    @media (max-width: 600px) {{
        .leaflet-popup-content-wrapper {{
            font-size: 1.5em;
        }}
        .leaflet-popup-content button {{
            font-size: 1.8em;
        }}
    }}
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
    var routeData = {json.dumps(route_geojson_data)};
    var cityData = {json.dumps(city_data)};
    var markers = [];
    var currentIndex = {initial_index};  // Set the initial index to the point with PointOrder = 1

    var map = L.map('map').setView([7.8731, 80.7718], 8);
    L.tileLayer('https://{{s}}.tile.openstreetmap.org/{{z}}/{{x}}/{{y}}.png', {{
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }}).addTo(map);

    // Add route line to the map with very dark pink-violet color
    L.geoJSON(routeData, {{
        style: function (feature) {{
            return {{ color: '#8B008B', weight: 4 }};  // Very dark pink-violet color
        }}
    }}).addTo(map);

    function createCustomIcon() {{
        return L.divIcon({{
            className: 'custom-marker'
        }});
    }}

    function updatePopup(index) {{
        var point = cityData[index];
        var popupContent = `
            <div>
                <button onclick="goToPreviousPoint()">&#8592;</button>
                <span><b>${{point.city_name}}</b></span>
                <button onclick="goToNextPoint()">&#8594;</button>
            </div>
        `;
        return popupContent;
    }}

    function refreshMap(index, initialZoom) {{
        markers.forEach(marker => map.removeLayer(marker)); // Remove existing markers
        markers = []; // Reset markers array

        cityData.forEach(function(item, idx) {{
            var marker = L.marker([item.latitude, item.longitude], {{ icon: createCustomIcon() }}).addTo(map);
            if (item.point_order != 0) {{
                marker.bindPopup(updatePopup(idx));
                marker.on('click', function() {{
                    currentIndex = idx; // Update currentIndex when a marker is clicked
                }});
            }}
            markers.push(marker);
        }});

        markers[index].openPopup();

        if (initialZoom) {{
            map.fitBounds(cityData.map(item => [item.latitude, item.longitude]));
        }} else {{
            map.flyTo([cityData[index].latitude, cityData[index].longitude], 10);
        }}
    }}

    function goToNextPoint() {{
        currentIndex = (currentIndex + 1) % cityData.length;
        refreshMap(currentIndex, false);
    }}

    function goToPreviousPoint() {{
        currentIndex = (currentIndex - 1 + cityData.length) % cityData.length;
        refreshMap(currentIndex, false);
    }}

    // Initialize the map with the first point's popup and zoom to all points
    refreshMap(currentIndex, true);
    </script>
</body>
</html>
"""

output_path = r"D:\GeethaAkkaBandarawela\TripToNorthMap9.html"
with open(output_path, "w") as file:
    file.write(html_content)
